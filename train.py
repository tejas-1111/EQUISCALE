from time import sleep
import shlex
import subprocess

MAX_JOBS = 8
USER = (str(subprocess.run("whoami", stdout=subprocess.PIPE).stdout))[2:-3]
print(USER)

# Possible start/end values
# 0.00625, 0.0125, 0.01875, 0.025, 0.03125, 0.0375, 0.04375, 0.05, 0.05625, 0.0625, 0.06875, 0.075, 0.08125, 0.0875, 0.09375, 0.1
# 0.10625, 0.1125, 0.11875, 0.125, 0.13125, 0.1375, 0.14375, 0.15, 0.15625, 0.1625, 0.16875, 0.175, 0.18125, 0.1875, 0.19375, 0.2
# 0.20625, 0.2125, 0.21875, 0.225, 0.23125, 0.2375, 0.24375, 0.25, 0.25625, 0.2625, 0.26875, 0.275, 0.28125, 0.2875, 0.29375, 0.3
# 0.30625, 0.3125, 0.31875, 0.325, 0.33125, 0.3375, 0.34375, 0.35, 0.35625, 0.3625, 0.36875, 0.375, 0.38125, 0.3875, 0.39375, 0.4
# 0.40625, 0.4125, 0.41875, 0.425, 0.43125, 0.4375, 0.44375, 0.45, 0.45625, 0.4625, 0.46875, 0.475, 0.48125, 0.4875, 0.49375

# Values used to search
# 0.00625, 0.03125, 0.05625, 0.08125, 0.10625, 0.13125, 0.15625, 0.18125, 0.20625, 0.23125, 0.25625, 0.28125, 0.30625, 0.33125, 0.35625, 0.38125, 0.40625, 0.43125, 0.45625, 0.48125

# Entry in setting should be of the form:
# {
#         "model": "RISAN",
#         "dataset": "Compas",
#         "fairness_condition": "Sep",
#         "costs": [0.10625, 0.13125, 0.15625, 0.18125, 0.20625, 0.23125, 0.25625, 0.28125, 0.30625, 0.33125, 0.35625, 0.38125, 0.40625],
# },

settings = [
    {
        "model": "RISAN",
        "dataset": "Adult",
        "fairness_condition": "None",
        "cost0": [0.125000, 0.136250, 0.147500, 0.158750, 0.170000, 0.181250, 0.192500, 0.203750, 0.215000, 0.226250, 0.237500, 0.248750, 0.260000, 0.271250, 0.282500, 0.293750, 0.305000, 0.316250, 0.327500, 0.338750, 0.350000],
        "cost1": [0.125000, 0.136250, 0.147500, 0.158750, 0.170000, 0.181250, 0.192500, 0.203750, 0.215000, 0.226250, 0.237500, 0.248750, 0.260000, 0.271250, 0.282500, 0.293750, 0.305000, 0.316250, 0.327500, 0.338750, 0.350000],
        "lr1": 1e-3,
        "lr2": 1e-3,
        "gamma": 1,
    },
    {
        "model": "RISAN",
        "dataset": "Adult",
        "fairness_condition": "Ind",
        "cost0": [0.175000, 0.183750, 0.192500, 0.201250, 0.210000, 0.218750, 0.227500, 0.236250, 0.245000, 0.253750, 0.262500, 0.271250, 0.280000, 0.288750, 0.297500, 0.306250, 0.315000, 0.323750, 0.332500, 0.341250, 0.350000],
        "cost1": [0.175000, 0.183750, 0.192500, 0.201250, 0.210000, 0.218750, 0.227500, 0.236250, 0.245000, 0.253750, 0.262500, 0.271250, 0.280000, 0.288750, 0.297500, 0.306250, 0.315000, 0.323750, 0.332500, 0.341250, 0.350000],
        "lr1": 1e-3,
        "lr2": 1e-3,
        "gamma": 1,
    },
    {
        "model": "RISAN",
        "dataset": "Adult",
        "fairness_condition": "Sep",
        "cost0": [0.275000, 0.283438, 0.291875, 0.300313, 0.308750, 0.317188, 0.325625, 0.334062, 0.342500, 0.350938, 0.359375, 0.367812, 0.376250, 0.384687, 0.393125, 0.401562, 0.410000, 0.418437, 0.426875, 0.435312, 0.443750],
        "cost1": [0.275000, 0.283438, 0.291875, 0.300313, 0.308750, 0.317188, 0.325625, 0.334062, 0.342500, 0.350938, 0.359375, 0.367812, 0.376250, 0.384687, 0.393125, 0.401562, 0.410000, 0.418437, 0.426875, 0.435312, 0.443750],
        "lr1": 1e-3,
        "lr2": 3e-3,
        "gamma": 1,
    },
    {
        "model": "RISAN",
        "dataset": "Adult",
        "fairness_condition": "Mixed",
        "cost0": [0.200000, 0.207500, 0.215000, 0.222500, 0.230000, 0.237500, 0.245000, 0.252500, 0.260000, 0.267500, 0.275000, 0.282500, 0.290000, 0.297500, 0.305000, 0.312500, 0.320000, 0.327500, 0.335000, 0.342500, 0.350000],
        "cost1": [0.200000, 0.207500, 0.215000, 0.222500, 0.230000, 0.237500, 0.245000, 0.252500, 0.260000, 0.267500, 0.275000, 0.282500, 0.290000, 0.297500, 0.305000, 0.312500, 0.320000, 0.327500, 0.335000, 0.342500, 0.350000],
        "lr1": 8e-3,
        "lr2": 4e-3,
        "gamma": 1,
    },
    {
        "model": "KP1",
        "dataset": "Adult",
        "fairness_condition": "None",
        "cost0": [0.150000, 0.161875, 0.173750, 0.185625, 0.197500, 0.209375, 0.221250, 0.233125, 0.245000, 0.256875, 0.268750, 0.280625, 0.292500, 0.304375, 0.316250, 0.328125, 0.340000, 0.351875, 0.363750, 0.375625, 0.387500],
        "cost1": [0.150000, 0.161875, 0.173750, 0.185625, 0.197500, 0.209375, 0.221250, 0.233125, 0.245000, 0.256875, 0.268750, 0.280625, 0.292500, 0.304375, 0.316250, 0.328125, 0.340000, 0.351875, 0.363750, 0.375625, 0.387500],
        "lr1": 1e-3,
        "lr2": 1e-3,
        "gamma": 1,
    },
    {
        "model": "KP1",
        "dataset": "Adult",
        "fairness_condition": "Ind",
        "cost0": [0.206250, 0.210938, 0.215625, 0.220312, 0.225000, 0.229687, 0.234375, 0.239062, 0.243750, 0.248437, 0.253125, 0.257812, 0.262500, 0.267187, 0.271875, 0.276562, 0.281250, 0.285937, 0.290625, 0.295312, 0.300000],
        "cost1": [0.206250, 0.210938, 0.215625, 0.220312, 0.225000, 0.229687, 0.234375, 0.239062, 0.243750, 0.248437, 0.253125, 0.257812, 0.262500, 0.267187, 0.271875, 0.276562, 0.281250, 0.285937, 0.290625, 0.295312, 0.300000],
        "lr1": 1e-3,
        "lr2": 5e-3,
        "gamma": 1,
    },
    {
        "model": "KP1",
        "dataset": "Adult",
        "fairness_condition": "Sep",
        "cost0": [0.200000, 0.205937, 0.211875, 0.217813, 0.223750, 0.229687, 0.235625, 0.241563, 0.247500, 0.253437, 0.259375, 0.265313, 0.271250, 0.277187, 0.283125, 0.289062, 0.295000, 0.300937, 0.306875, 0.312812, 0.318750],
        "cost1": [0.200000, 0.205937, 0.211875, 0.217813, 0.223750, 0.229687, 0.235625, 0.241563, 0.247500, 0.253437, 0.259375, 0.265313, 0.271250, 0.277187, 0.283125, 0.289062, 0.295000, 0.300937, 0.306875, 0.312812, 0.318750],
        "lr1": 5e-3,
        "lr2": 5e-3,
        "gamma": 1,
    },
    {
        "model": "KP1",
        "dataset": "Adult",
        "fairness_condition": "Mixed",
        "cost0": [0.200000, 0.206563, 0.213125, 0.219688, 0.226250, 0.232813, 0.239375, 0.245938, 0.252500, 0.259062, 0.265625, 0.272188, 0.278750, 0.285312, 0.291875, 0.298438, 0.305000, 0.311562, 0.318125, 0.324688, 0.331250],
        "cost1": [0.200000, 0.206563, 0.213125, 0.219688, 0.226250, 0.232813, 0.239375, 0.245938, 0.252500, 0.259062, 0.265625, 0.272188, 0.278750, 0.285312, 0.291875, 0.298438, 0.305000, 0.311562, 0.318125, 0.324688, 0.331250],
        "lr1": 1e-3,
        "lr2": 5e-3,
        "gamma": 1,
    },
]


def alive(x):
    return x.poll() is None


processes = []
for s in settings:
    for c0, c1 in zip(s["cost0"], s["cost1"]):
        command = f"python -Wi main.py --dataset {s['dataset']} --model {s['model']} --fairness_condition {s['fairness_condition']} --cost_0 {c0} --cost_1 {c1} --lr1 {s['lr1']} --lr2 {s['lr2']} --gamma {s['gamma']} --tqdm No"
        cmd = shlex.split(command)
        while len(processes) >= MAX_JOBS:
            processes = list(filter(alive, processes))
            sleep(1)
        p = subprocess.Popen(
            cmd,
            stdout=open(
                f"{s['dataset']}_{s['model']}_{s['fairness_condition']}_{c0}_{c1}.txt",
                "w",
            ),
        )
        processes.append(p)
        sleep(1)

while len(processes) != 0:
    processes = list(filter(alive, processes))
    sleep(1)
print("Finished")

